#include <stdint.h>
#include <stdio.h>
#include "uart.h"
#include "i2c.h"
#include "SSD1306.h"
#include "button.h"
#include "systick.h"

#define LED_PIN_LOW (1U << 29)
#define LED_PIN_HIGH (1U << 13)

#define PIN13 (1U << 13)
#define LED_PIN PIN13

#define GPIOAEN (1U << 0)
#define GPIOCEN (1U << 2)

const char dino1[] = {
    0b00000000, 0b00000000, 0b00000000, 0b00000000,
    0b00000000, 0b00000111, 0b11111110, 0b00000000,
    0b00000000, 0b00000110, 0b11111111, 0b00000000,
    0b00000000, 0b00001110, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11000000, 0b00000000,
    0b00000000, 0b00001111, 0b11111100, 0b00000000,
    0b01000000, 0b00001111, 0b11000000, 0b00000000,
    0b01000000, 0b00011111, 0b10000000, 0b00000000,
    0b01000000, 0b01111111, 0b10000000, 0b00000000,
    0b01100000, 0b11111111, 0b11100000, 0b00000000,
    0b01110001, 0b11111111, 0b10100000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b00111111, 0b11111111, 0b00000000, 0b00000000,
    0b00011111, 0b11111111, 0b00000000, 0b00000000,
    0b00001111, 0b11111110, 0b00000000, 0b00000000,
    0b00000011, 0b11111100, 0b00000000, 0b00000000,
    0b00000001, 0b11011100, 0b00000000, 0b00000000,
    0b00000001, 0b10001100, 0b00000000, 0b00000000,
    0b00000001, 0b10001100, 0b00000000, 0b00000000,
    0b00000001, 0b00001100, 0b00000000, 0b00000000,
    0b00000001, 0b10001110, 0b00000000, 0b00000000};

const char dino2[] = {
    0b00000000, 0b00000000, 0b00000000, 0b00000000,
    0b00000000, 0b00000111, 0b11111110, 0b00000000,
    0b00000000, 0b00000110, 0b11111111, 0b00000000,
    0b00000000, 0b00001110, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11000000, 0b00000000,
    0b00000000, 0b00001111, 0b11111100, 0b00000000,
    0b01000000, 0b00001111, 0b11000000, 0b00000000,
    0b01000000, 0b00011111, 0b10000000, 0b00000000,
    0b01000000, 0b01111111, 0b10000000, 0b00000000,
    0b01100000, 0b11111111, 0b11100000, 0b00000000,
    0b01110001, 0b11111111, 0b10100000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b00111111, 0b11111111, 0b00000000, 0b00000000,
    0b00011111, 0b11111111, 0b00000000, 0b00000000,
    0b00001111, 0b11111110, 0b00000000, 0b00000000,
    0b00000011, 0b11111100, 0b00000000, 0b00000000,
    0b00000001, 0b11011100, 0b00000000, 0b00000000,
    0b00000001, 0b00001100, 0b00000000, 0b00000000,
    0b00000001, 0b10001100, 0b00000000, 0b00000000,
    0b00000000, 0b00001100, 0b00000000, 0b00000000,
    0b00000000, 0b00001110, 0b00000000, 0b00000000};
const char dino3[] = {
    0b00000000, 0b00000000, 0b00000000, 0b00000000,
    0b00000000, 0b00000111, 0b11111110, 0b00000000,
    0b00000000, 0b00000110, 0b11111111, 0b00000000,
    0b00000000, 0b00001110, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11111111, 0b00000000,
    0b00000000, 0b00001111, 0b11000000, 0b00000000,
    0b00000000, 0b00001111, 0b11111100, 0b00000000,
    0b01000000, 0b00001111, 0b11000000, 0b00000000,
    0b01000000, 0b00011111, 0b10000000, 0b00000000,
    0b01000000, 0b01111111, 0b10000000, 0b00000000,
    0b01100000, 0b11111111, 0b11100000, 0b00000000,
    0b01110001, 0b11111111, 0b10100000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b01111111, 0b11111111, 0b10000000, 0b00000000,
    0b00111111, 0b11111111, 0b00000000, 0b00000000,
    0b00011111, 0b11111111, 0b00000000, 0b00000000,
    0b00001111, 0b11111110, 0b00000000, 0b00000000,
    0b00000011, 0b11111100, 0b00000000, 0b00000000,
    0b00000001, 0b11011100, 0b00000000, 0b00000000,
    0b00000001, 0b10001110, 0b00000000, 0b00000000,
    0b00000001, 0b10000000, 0b00000000, 0b00000000,
    0b00000001, 0b00000000, 0b00000000, 0b00000000,
    0b00000001, 0b10000000, 0b00000000, 0b00000000};

static const unsigned char tree1[] = {
    0b00011110, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b01000000,
    0b00011111, 0b11100000,
    0b00011111, 0b11100000,
    0b11011111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11100000,
    0b11111111, 0b11000000,
    0b11111111, 0b00000000,
    0b11111111, 0b00000000,
    0b01111111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000,
    0b00011111, 0b00000000};

// void update_game();

void draw_horizon()
{
    for (int x = 0; x < 128; x++)
    {
        setPixel(x, 55, 1);
    }
}

void drawStars()
{
    setPixel(6, 15, 1);
    setPixel(124, 28, 1);
    setPixel(64, 10, 1);
    setPixel(30, 10, 1);
    setPixel(87, 20, 1);
    setPixel(56, 27, 1);
    setPixel(100, 10, 1);
}

void delay(volatile int x)
{
    for (; x > 0; x--)
        ;
}

void jump_dino(int *gg)
{
    int y = 32;
    for (y; y > 3; y-=3)
    {
        drawBitMapBuffer(10, y, dino1, 26, 25);
        drawStars();
        draw_horizon();
        drawBitMapBuffer(*gg, 32, tree1, 23, 11);
        *gg -= 3;
        updateDisplay();
        clear_buffer();
       
    }
    for(int x = 0; x < 8; x++){
        drawBitMapBuffer(10, y, dino1, 26, 25);
        drawStars();
        draw_horizon();
        drawBitMapBuffer(*gg, 32, tree1, 23, 11);
        *gg -= 3;
        updateDisplay();
        clear_buffer();
        
    }

    for (y; y < 33; y+=3)
    {
        drawBitMapBuffer(10, y, dino1, 26, 25);
        drawStars();
        draw_horizon();
        drawBitMapBuffer(*gg, 32, tree1, 23, 11);
        *gg -= 3;
        updateDisplay();
        clear_buffer();
        
    }
}

void draw_dino(){
    static int dd = 0;
    if(dd >= 0 && dd < 4){
        drawBitMapBuffer(10, 32, dino2, 26, 25);
    }
    else if(dd >= 4 && dd <= 8){
        drawBitMapBuffer(10, 32, dino3, 26, 25);
        if(dd == 8){
            dd = 0;
        }
    }
    dd++;
}

int main()
{
    uar2_tx_init();
    i2c_init();
    SSD1306_init(); // Initialize the OLED display
    SSD1306_clear();
    button_init();

    int gg = 126;
    int ghg = 0;
    while (1)
    {   
        
        if ((isbutton_clicked()))
        {   
            jump_dino(&gg);
            systickDelayMs(10);
        }
        else
        {
            drawBitMapBuffer(gg, 32, tree1, 23, 11);
            gg -= 3;
            drawStars();
            draw_horizon();
            draw_dino();
            updateDisplay();
            clear_buffer();
            if (gg < -60)
            {
                gg = 126;
            }
        }
    }
}